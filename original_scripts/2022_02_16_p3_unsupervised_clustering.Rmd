---
title: 'P3: Unsupervised Clustering'
author: "Brandon Bergsneider"
date: "2/16/2022"
output: html_document
---

### This script conducts unsupervised clustering of all 1128 PBT patients using

### a modified version of the concordance network clustering method used in Henry et al., 2018

### Load packages

```{r, results=FALSE, message=FALSE, warning=FALSE}
#Load packages
library("dplyr")
library("tidyr")
library("qgraph")
library("igraph")
library("mclust")
library("ComplexHeatmap")
library("circlize")
library("EGAnet")
library("resample")
library("ggplot2")
library("reshape2")
library("gridExtra")
library("NetworkComparisonTest")
library("reporttools")
library("ggpubr")
library("ggmosaic")
library("viridisLite")
library("bootnet")
library("networktools")
library(tidyverse)
library(RColorBrewer)
orange="#ff7f00"
green="#4caf4a"
red="#e4211c"
blue="#387db8"
teal="#3e8c97"
gray="#66666b"
gold="#f7c708"
centrality_colors <- c("Strength"=red, "Closeness"=blue, "Betweenness"=orange)
bridge_centrality_colors <- centrality_colors
names(bridge_centrality_colors) <- sapply(names(bridge_centrality_colors), function(x) paste0("Bridge\n",x))

community_colors <- rev(RColorBrewer::brewer.pal(5, "BuPu"))[1:4]
names(community_colors) <- sapply(1:4, function(x) paste0("PC",x))
community_colors[2] <- "gold2"


```

### Functions for conducting unsupervised clustering on continuous data

```{r}

vec2concord <- function(vec){
  (vec %*% t(vec))/100
}

vecs2concords <- function(mat) {
  # aggregate concordance matrices in a list
  lapply(1:nrow(mat), function(i) vec2concord(mat[i,]))
}

similarity_matrix <- function(mat, concords=vecs2concords(mat), simil_measure='ARI') {
  
  # Compute similarities
  sims <- NULL

  if (simil_measure == 'Euclidean') {
    a.conc <- t(apply(mat, 1, function(x) (x%*%t(x))[upper.tri(x%*%t(x), diag=FALSE)])) # taking just upper triangle w/o diagonal
    dists <- as.matrix(dist(a.conc))
    sims <- sqrt(1/(1+dists))
  } else {
    sims <- matrix(0, nrow=length(concords), ncol=length(concords))

    # vectorize concords
    vConcords <- lapply(1:length(concords), function(i) as.vector(concords[[i]][upper.tri(concords[[i]], diag = F)]))

    # compute similarity matrix by calculating pairwise ARI
    # (upper triangular part - not including diagonal)
    for (i in 1:(nrow(sims)-1)) {
      for (j in (i+1):ncol(sims)) {
        sims[i,j] <- adjustedRandIndex(vConcords[[i]], vConcords[[j]]) # BB edit: ARI function changed from adjustedRand in archived clues package to adjustedRandIndex in mclust package
      }
    }

    # reflect upper triangle across diagonal (cause symmetric)
    sims = sims + t(sims)
    
    # diagonal (all 1s)
    # BB edit: all diagonal values set to 1 after (rather than before) reflection across diagonal to prevent diagonal adding to itself
    for (i in 1:nrow(mat)) {
      sims[i,i] <- 1
    }
  }

  # set negative entries to 0
  sims[sims < 0] <- 0

  sims
}

get_communities <- function(data, nrows=nrow(data), ncols=ncol(data), thresh=1, detectAlgo='WT', simil_measure='ARI', simplify_graphs=TRUE) {
  # convert dataframe to matrix
  mat <- as.matrix(data)

  # if matrix is empty throw error
  if (nrow(mat) == 0){
    stop(safeError('Matrix was empty.'))
  }
  
  # ensure reproducibility
  set.seed(42)
  
  # fix row names
  rownames(mat) <- NULL
  
  # compute between patient similarity (generate similarity matrix)
  concords <- vecs2concords(mat)
  sims <- similarity_matrix(mat, concords, simil_measure=simil_measure)
  
  # convert sims to a graph to prepare for random walk
  g <- graph_from_adjacency_matrix(sims, mode='undirected', weighted=TRUE, diag=FALSE)
  
  # remove multi-edges and loops
  if (simplify_graphs) {
    g <- simplify(g)
  }
  
  # run community detection algorithm to get communities (the default is Random Walk (walktrap))
  comms <- NULL
  
  if (detectAlgo == 'FG'){
    comms <- cluster_fast_greedy(g)
  } else if (detectAlgo == 'IM'){
    comms <- cluster_infomap(g)
  } else if (detectAlgo == 'LP'){
    comms <- cluster_label_prop(g)
  } else if (detectAlgo == 'LE'){
    comms <- cluster_leading_eigen(g)
  } else if (detectAlgo == 'LV'){
    comms <- cluster_louvain(g)
  } else {
    comms <- cluster_walktrap(g)
  }
  
  # convert comms to regular r list
  comms <- lapply(igraph::groups(comms), function(x) as.numeric(x))
  
  # create list of the subset of data for each community
  comms_data <- lapply(1:length(comms), FUN=function(i){
    mat[comms[[i]],]
  })
  
  # return list of communities and list of data for each community
  return(list(comms,comms_data))
}

```

### Load data

```{r, results=FALSE, message=FALSE, warning=FALSE}
# Load data
symptom_data <- read.csv('data/p1_reduced_all_symptom_data.csv', stringsAsFactors = FALSE)
colnames(symptom_data) <- gsub("\\.","-", colnames(symptom_data))
```

### Conduct unsupervised clustering using ARI as distance measurement

```{r}
if (!file.exists("data/comms.RDS")){
  comms <- get_communities(symptom_data)
  saveRDS(comms, "data/comms.RDS")
}
comms <- readRDS("data/comms.RDS")
```

```{r}
comms[[1]]

comm.assignment <- Reduce(rbind, sapply(names(comms[[1]]), function(x){
  cbind(community=paste0("PC",x), sample=comms[[1]][[x]])
})) %>% data.frame(stringsAsFactors = FALSE) %>% mutate(sample=as.numeric(sample)) %>% arrange(sample)
```

```{r}
lapply(comms[[1]], length)
```

### Analyze symptom burden of each cluster

```{r}
comm1_symptom_data <- symptom_data[comms[[1]][[1]],]
comm2_symptom_data <- symptom_data[comms[[1]][[2]],]
comm3_symptom_data <- symptom_data[comms[[1]][[3]],]
comm4_symptom_data <- symptom_data[comms[[1]][[4]],]
```

```{r,fig.width=6,fig.height=4.5}
col_fun = colorRamp2(c(0,10),c('white',red))
column_ha = HeatmapAnnotation(`patient cluster` = comm.assignment$community, col=list(`patient cluster`=community_colors), show_legend = FALSE)
lgd = Legend(col_fun = col_fun, title = "severity", at = c(0, 5, 10), direction = "horizontal")
p <- Heatmap(data.matrix(t(symptom_data)), col=col_fun, column_split=comm.assignment$community, cluster_column_slices = FALSE, name="severity", show_column_dend = FALSE, top_annotation = column_ha)
draw(p, heatmap_legend_side = "left")
```

```{r, fig.height=4.5, fig.width=4}
symptom_order <- rev(colnames(symptom_data)[row_order(p)])
all_data <- comm.assignment %>% bind_cols(symptom_data)
all_data_melt <- all_data %>% pivot_longer(cols=-c(community, sample), names_to="symptom", values_to ="severity") %>% mutate(symptom=factor(symptom, levels=symptom_order)) %>%  arrange(symptom)

all_data_stats <- all_data_melt %>% group_by(community, symptom) %>% summarize(mean_severity=mean(severity), mild_severe=100*length(which(severity > 0))/length(severity), moderate_severe=100*length(which(severity > 4))/length(severity))


pp <- ggplot(all_data_stats, aes(x=mild_severe, y=symptom, group=community, color=community)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=community_colors) +
  theme_minimal() +
  xlab("% mild-severe occurrence") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x =element_text(size=12),
        axis.title.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.text = element_text(size=12), legend.title=element_blank())
pp

pp <- ggplot(all_data_stats, aes(x=moderate_severe, y=symptom, group=community, color=community)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=community_colors) +
  theme_minimal() +
  xlab("% moderate-severe occurrence") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x =element_text(size=12),
        axis.title.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.text = element_text(size=12), legend.title=element_blank())
pp

pp <- ggplot(all_data_stats, aes(x=mean_severity, y=symptom, group=community, color=community)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=community_colors) +
  theme_minimal() +
  xlab("average severity") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x =element_text(size=12),
        axis.title.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.text = element_text(size=12), legend.title=element_blank())
pp
```

```{r, fig.height=4.5, fig.width=1.5}
pp <- ggplot(all_data_stats, aes(x=mild_severe, y=symptom, group=community, color=community)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=community_colors) +
  theme_minimal() +
  xlab("mild-severe\noccurrence %") + 
  ylab("") + 
  scale_x_continuous(position = "top", limits=c(0,100)) +
  theme(axis.text.x =element_text(size=12),
        axis.text.y =element_blank(),
        axis.title.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.text = element_text(size=12), legend.title=element_blank(), legend.position="none")
pp

pp <- ggplot(all_data_stats, aes(x=moderate_severe, y=symptom, group=community, color=community)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=community_colors) +
  theme_minimal() +
  xlab("moderate-severe\noccurrence %") + 
  ylab("") + 
  scale_x_continuous(position = "top", limits=c(0,100)) +
  theme(axis.text.x =element_text(size=12),
        axis.text.y =element_blank(),
        axis.title.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.text = element_text(size=12), legend.title=element_blank(), legend.position="none")
pp
pp <- ggplot(all_data_stats, aes(x=mean_severity, y=symptom, group=community, color=community)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=community_colors) +
  theme_minimal() +
  xlab("average\nseverity") + 
  ylab("") + 
  scale_x_continuous(position = "top") +
  theme(axis.text.x =element_text(size=12),
        axis.text.y =element_blank(),
        axis.title.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.text = element_text(size=12), legend.title=element_blank(), legend.position="none")
pp
```

```{r, fig.height=4.5, fig.width=9}
pp <- ggplot(all_data_melt, aes(x=severity, y=symptom, #fill=community, 
                                color=community)) + 
  geom_boxplot()+  
  scale_color_manual(values=community_colors) +
  #scale_fill_manual(values=community_colors) +
  facet_wrap(~community, ncol=4) + 
  theme_minimal() +
  xlab("average severity") + 
  ylab("") + 
  #scale_x_discrete(position = "top") +
  theme(axis.text.x =element_text(size=12),
        axis.text.y =element_text(size=12),
        axis.title.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.text = element_text(size=12), legend.title=element_blank())
pp
```

### Construct networks for each cluster

### Networks could not be constructed for networks 3 and 4 because of lack of variance in some variables

### Network 1 appears much like the all patient network, whereas Network 2 appears to define a subset

### of patients in which cognitive symptoms (understanding, remembering, concentrating, speaking) drive

### the network

```{r}
# Calculate the correlation matrices for each cluster
# Assume that all variables are continuous and non-normal
comm1_cor_matrix <- cor_auto(comm1_symptom_data, detectOrdinal = FALSE, npn.SKEPTIC = TRUE, forcePD = TRUE)
comm2_cor_matrix <- cor_auto(comm2_symptom_data, detectOrdinal = FALSE, npn.SKEPTIC = TRUE, forcePD = TRUE)
# comm3_cor_matrix <- cor_auto(comm3_symptom_data, detectOrdinal = FALSE, npn.SKEPTIC = TRUE, forcePD = TRUE)
# comm4_cor_matrix <- cor_auto(comm4_symptom_data, detectOrdinal = FALSE, npn.SKEPTIC = TRUE, forcePD = TRUE)
```

```{r,fig.width=5, fig.height=4}
# Construct an EBIC-GLASSO regularized GGM using the EGA function from EGAnet
# EGA also identifies symptom clusters using the walktrap algorithm
comm1_ega <- EGA(comm1_cor_matrix, n = nrow(comm1_symptom_data), plot.EGA = FALSE)
# comm1_plot.ega <- plot(comm1_ega, plot.args = list(node.size = 8, label.size = 4, color.palette=c("#96e9f5","#d5e59c","#ffb27a","#ff7679")))
comm1_plot.ega <- plot(comm1_ega, plot.args = list(node.size = 8, label.size = 3.5, color.palette = c(orange, red, green, blue), legend.names=c("physical" , "focal neurologic", "affective",  "cognitive")))
comm1_plot.ega + theme(legend.position = "bottom")
#ggsave('images/PC1.png', plot = comm1_plot.ega, width = 8, height = 5)
```

```{r, eval=FALSE}
comm1_plot.ega <- plot(comm1_ega, plot.args = list(node.size = 8, label.size = 6))
# ggsave('poster_images/PC1.png', plot = comm1_plot.ega, width = 8, height = 5)
```

```{r}
# Analyze stability of dimensions using parametric bootstrapping with 10,000 iterations
if(!file.exists("data/comm1_boot.ega.RDS")){
  comm1_boot.ega <- bootEGA(comm1_cor_matrix, n = nrow(comm1_symptom_data), iter = 10000, type = 'parametric')
  saveRDS(comm1_boot.ega, file=file.path("data/comm1_boot.ega.RDS"))
}
comm1_boot.ega <- readRDS(file.path("data/comm1_boot.ega.RDS"))
```

```{r}
# Calculate both item and dimension stability
comm1_dimStab <- dimensionStability(comm1_boot.ega)
```

```{r, fig.width=1.8, fig.height=1.6}
comm1_dimStab$item.stability$plot + theme_minimal() + scale_color_manual(values=c(blue, green, orange, red)) + 
  ylab("replication proportion") + 
  xlab("") + 
  theme(axis.text.y =element_text(size=11),
        axis.text.x=element_text(size=11),
        strip.text=element_text(size=11), 
        axis.title.y=element_text(size=11),
        legend.position = "none") 
```

```{r, fig.width=5, fig.height=4}
comm2_ega <- EGA(comm2_cor_matrix, n = nrow(comm2_symptom_data), plot.EGA = FALSE)
comm2_plot.ega <- plot(comm2_ega, plot.args = list(node.size = 8, label.size = 3.5, color.palette = c(gray, teal, gold), legend.names=c("mixed",  "mixed ", "cognitive-affective"))) 
comm2_plot.ega <- comm2_plot.ega + theme(legend.position = "bottom")
#comm2_plot.ega <- plot(comm2_ega, plot.args = list(node.size = 8, label.size = 5.5))
#ggsave('images/PC2.png', plot = comm2_plot.ega, width = 8, height = 5)
```

`{r. eval=FALSE} comm2_plot.ega <- plot(comm2_ega, plot.args = list(node.size = 8, label.size = 6)) ggsave('poster_images/PC2.png', plot = comm2_plot.ega, width = 8, height = 5)`

```{r}
# Only ran 500 iterations because otherwise bootstrapping method crashes due to reaching sampling limit (likely due to sparsity of network)
if(!file.exists("data/comm2_boot.ega.RDS")){
  comm2_boot.ega <- bootEGA(comm2_cor_matrix, n = nrow(comm2_symptom_data), iter = 500, type = 'parametric')
  saveRDS(comm2_boot.ega, file=file.path("data/comm2_boot.ega.RDS"))
}
comm2_boot.ega <- readRDS(file.path("data/comm2_boot.ega.RDS"))
```

```{r}
comm2_dimStab <- dimensionStability(comm2_boot.ega)
```

```{r, fig.width=1.8, fig.height=1.6}
comm2_dimStab$item.stability$plot + theme_minimal() + scale_color_manual(values=c(teal, gold, gray)) + 
  ylab("replication proportion") + 
  xlab("") + 
  theme(axis.text.y =element_text(size=11),
        axis.text.x=element_text(size=11),
        strip.text=element_text(size=11), 
        axis.title.y=element_text(size=11),
        legend.position = "none")
```

```{r, eval=FALSE}
# Compare network centrality measures
centralityPlot(list('PC1'=comm1_ega$network,'PC2'=comm2_ega$network), include = c("Strength","Closeness","Betweenness"), scale = "z-score", orderBy = "Strength") + theme(text = element_text(size = 15))
```

```{r, fig.width=6, fig.height=4.5}
centralities <- list(PC1=centralityTable(comm1_ega$network),
                     PC2=centralityTable(comm2_ega$network))
centralities <- lapply(centralities, function(cc){
  cc %>% filter(measure %in% c("Strength", "Closeness", "Betweenness")) %>% select(node, measure, value)
})
orderbystrength <- centralities$PC1%>%filter(measure=="Strength") %>% arrange(value) %>% select(node)
centralities <- lapply(names(centralities), function(cc){
  centralities[[cc]] %>% group_by(measure) %>% mutate(node = factor(node, levels=orderbystrength$node), measure=factor(measure, levels=c("Strength", "Closeness", "Betweenness")), cluster=cc)
})

centralities <- Reduce(rbind, centralities) %>% data.frame() %>% group_by(measure, cluster) %>% arrange(node)
p <- ggplot(centralities, aes(x=value, y=node, group=interaction(measure, cluster), color=cluster)) +
  geom_point(size=2) + geom_path(size=0.7) +
  scale_color_manual(values=community_colors[c("PC1","PC2")]) +
  facet_wrap(~measure, ncol=3) + theme_minimal() +
  xlab("") +
  ylab("") +
  theme(axis.text.y =element_text(size=12),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=12),
        legend.text = element_text(size=12), legend.title=element_blank()#,
        #legend.position = "none"
        )
p
```

```{r, fig.width=5, fig.height=4.5}
centralities <- list(PC1=centralityTable(comm1_ega$network),
                     PC2=centralityTable(comm2_ega$network))
centralities <- lapply(names(centralities), function(cc){
  dd <- centralities[[cc]] %>% filter(measure %in% c("Strength", "Closeness", "Betweenness")) %>% select(node, measure, value)
  orderbystrength <- dd%>%filter(measure=="Strength") %>% arrange(value) %>% select(node)
  dd %>% group_by(measure) %>% mutate(node = factor(node, levels=orderbystrength$node), measure=factor(measure, levels=c("Strength", "Closeness", "Betweenness")), cluster=cc) %>% arrange(node)
})

lapply(centralities, function(dd){
p <- ggplot(dd, aes(x=value, y=node, group=interaction(measure, cluster), color=cluster)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=community_colors[c("PC1","PC2")]) +
  facet_wrap(~measure, ncol=3) + theme_minimal() +
  xlab("") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=12),
        legend.position = "none"
        )
})
```

```{r, eval=FALSE}
centality_comparison_plot <- centralityPlot(list('PC1'=comm1_ega$network,'PC2'=comm2_ega$network), include = c("Strength","Closeness","Betweenness"), scale = "z-score", orderBy = "Strength") + theme(text = element_text(size = 20))
# ggsave('images/centrality_comparison_plot.png', plot = centality_comparison_plot, width = 8, height = 5)
```

```{r, eval=FALSE}
centality_comparison_plot <- centralityPlot(list('PC1'=comm1_ega$network,'PC2'=comm2_ega$network), include = c("Strength","Closeness","Betweenness"), scale = "z-score", orderBy = "Strength") + theme(text = element_text(size = 20))
# ggsave('poster_images/centrality_comparison_plot.png', plot = centality_comparison_plot, width = 8, height = 5)
```

```{r}
# Centrality stats for comm1
comm1_centrality_stats <- centrality_auto(comm1_ega$network)
comm1_centrality_table <- comm1_centrality_stats$node.centrality
DT::datatable(comm1_centrality_table)
```

```{r, fig.width=3.5, fig.height=2}
centralities <- centralityTable(comm1_ega$network) %>% filter(measure %in% c("Strength", "Closeness", "Betweenness")) %>% select(node, measure, value)
orderbystrength <- centralities%>%filter(measure=="Strength") %>% arrange(value) %>% select(node)
centralities <- centralities %>% group_by(measure) %>% mutate(node = factor(node, levels=orderbystrength$node), measure=factor(measure, levels=c("Strength", "Closeness", "Betweenness"))) %>% arrange(node)
p <- ggplot(centralities %>% group_by(measure), aes(x=value, y=node, group=measure, color=measure)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=centrality_colors) +
  facet_wrap(~measure, ncol=3) + theme_minimal() +
  xlab("") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.position = "none")
p

```

```{r}
# Centrality stats for comm2
comm2_centrality_stats <- centrality_auto(comm2_ega$network)
comm2_centrality_table <- comm2_centrality_stats$node.centrality
DT::datatable(comm2_centrality_table)
```

```{r, fig.width=3.5, fig.height=2}
centralities <- centralityTable(comm2_ega$network) %>% filter(measure %in% c("Strength", "Closeness", "Betweenness")) %>% select(node, measure, value)
orderbystrength <- centralities%>%filter(measure=="Strength") %>% arrange(value) %>% select(node)
centralities <- centralities %>% group_by(measure) %>% mutate(node = factor(node, levels=orderbystrength$node), measure=factor(measure, levels=c("Strength", "Closeness", "Betweenness"))) %>% arrange(node)
p <- ggplot(centralities %>% group_by(measure), aes(x=value, y=node, group=measure, color=measure)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=centrality_colors) +
  facet_wrap(~measure, ncol=3) + theme_minimal() +
  xlab("") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.position = "none")
p

```

### Compare bridge centralities

```{r}
comm1_bridge_centralities <- bridge(comm1_ega$network, communities=comm1_ega$wc)
comm2_bridge_centralities <- bridge(comm2_ega$network, communities=comm2_ega$wc)
```

```{r}
comm1_bridge_centrality_table <- as.data.frame(list(comm1_bridge_centralities$'Bridge Strength', comm1_bridge_centralities$'Bridge Betweenness', comm1_bridge_centralities$'Bridge Closeness'), col.names = list('Bridge Strength','Bridge Betweenness','Bridge Closeness'))
comm2_bridge_centrality_table <- as.data.frame(list(comm2_bridge_centralities$'Bridge Strength', comm2_bridge_centralities$'Bridge Betweenness', comm2_bridge_centralities$'Bridge Closeness'), col.names = list('Bridge Strength','Bridge Betweenness','Bridge Closeness'))
```

```{r, fig.width=3.5, fig.height=2}
comm1_bridge_centrality_scaled <- apply(comm1_bridge_centrality_table, 2, scale) %>% as.data.frame()
comm1_bridge_centrality_scaled$node = rownames(comm1_bridge_centrality_table)
comm1_bridge_centrality_scaled <- comm1_bridge_centrality_scaled %>% pivot_longer(!node, names_to="measure", values_to = "value")
comm1_bridge_centrality_scaled <- comm1_bridge_centrality_scaled %>% rowwise() %>% mutate(measure=gsub("\\.", "\n", measure))

orderbystrength <- comm1_bridge_centrality_scaled%>%filter(measure=="Bridge\nStrength") %>% arrange(value) %>% select(node)
comm1_bridge_centrality_scaled <- comm1_bridge_centrality_scaled %>% group_by(measure) %>% mutate(node = factor(node, levels=orderbystrength$node), measure=factor(measure, levels=c("Bridge\nStrength", "Bridge\nCloseness", "Bridge\nBetweenness"))) %>% arrange(node)
p <- ggplot(comm1_bridge_centrality_scaled %>% group_by(measure), aes(x=value, y=node, group=measure, color=measure)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=bridge_centrality_colors) +
  facet_wrap(~measure, ncol=3) + theme_minimal() +
  xlab("") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.position = "none")
p

```

```{r, fig.width=3.5, fig.height=2}
comm2_bridge_centrality_scaled <- apply(comm2_bridge_centrality_table, 2, scale) %>% as.data.frame()
comm2_bridge_centrality_scaled$node = rownames(comm2_bridge_centrality_table)
comm2_bridge_centrality_scaled <- comm2_bridge_centrality_scaled %>% pivot_longer(!node, names_to="measure", values_to = "value")
comm2_bridge_centrality_scaled <- comm2_bridge_centrality_scaled %>% rowwise() %>% mutate(measure=gsub("\\.", "\n", measure))

orderbystrength <- comm2_bridge_centrality_scaled%>%filter(measure=="Bridge\nStrength") %>% arrange(value) %>% select(node)
comm2_bridge_centrality_scaled <- comm2_bridge_centrality_scaled %>% group_by(measure) %>% mutate(node = factor(node, levels=orderbystrength$node), measure=factor(measure, levels=c("Bridge\nStrength", "Bridge\nCloseness", "Bridge\nBetweenness"))) %>% arrange(node)
p <- ggplot(comm2_bridge_centrality_scaled %>% group_by(measure), aes(x=value, y=node, group=measure, color=measure)) + 
  geom_point(size=2) + geom_path(size=0.7) +  
  scale_color_manual(values=bridge_centrality_colors) +
  facet_wrap(~measure, ncol=3) + theme_minimal() +
  xlab("") + 
  ylab("") + 
  theme(axis.text.y =element_text(size=12),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=12), 
        legend.position = "none")
p

```

```{r, fig.width=3.5, fig.height=2.5}
comm1_bridge_centrality_scaled$node <- as.character(comm1_bridge_centrality_scaled$node)
comm2_bridge_centrality_scaled$node <- as.character(comm2_bridge_centrality_scaled$node)
centralities <- list(PC1=comm1_bridge_centrality_scaled,
                     PC2=comm2_bridge_centrality_scaled)
centralities <- lapply(centralities, function(cc){
  cc %>% filter(measure %in% c("Bridge\nStrength", "Bridge\nCloseness", "Bridge\nBetweenness")) %>% select(node, measure, value)
})
orderbystrength <- centralities$PC1%>%filter(measure=="Bridge\nStrength") %>% arrange(value) %>% select(node)
centralities <- lapply(names(centralities), function(cc){
  centralities[[cc]] %>% group_by(measure) %>% mutate(node = factor(node, levels=orderbystrength$node), measure=factor(measure, levels=c("Bridge\nStrength", "Bridge\nCloseness", "Bridge\nBetweenness")), cluster=cc)
})
centralities <- Reduce(rbind, centralities) %>% data.frame() %>% group_by(measure, cluster) %>% arrange(node)
p <- ggplot(centralities, aes(x=value, y=node, group=interaction(measure, cluster), color=cluster)) +
  geom_point(size=2) + geom_path(size=0.7) +
  scale_color_manual(values=community_colors[c("PC1","PC2")]) +
  facet_wrap(~measure, ncol=3) + theme_minimal() +
  xlab("") +
  ylab("") +
  theme(axis.text.y =element_text(size=12),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=12),
        legend.text = element_text(size=12), legend.title=element_blank()#,
        #legend.position = "none"
        )
p
```

### Try constructing networks for clusters 3 and 4, dropping nodes with no variance

### Networks could not be constructed because empty networks were selected for each cluster

```{r}
# Check variance of each column in cluster 3
colVars(comm3_symptom_data)
```

```{r}
# Remove the understanding and concentrating nodes from comm3_symptom_data as they have no variance
reduced_comm3_symptom_data <- comm3_symptom_data %>%
  select(-understanding,-concentrating)
```

```{r}
# Calculate the correlation matrix for cluster 3
# Assume that all variables are continuous and non-normal
comm3_cor_matrix <- cor_auto(reduced_comm3_symptom_data, detectOrdinal = FALSE, npn.SKEPTIC = TRUE, forcePD = TRUE)
```

```{r}
# Construct an EBIC-GLASSO regularized GGM using the EGA function from EGAnet
# EGA also identifies symptom clusters using the walktrap algorithm
comm3_ega <- EGA(comm3_cor_matrix, n = nrow(comm3_symptom_data), plot.EGA = FALSE)
# comm3_plot.ega <- plot(comm3_ega, plot.args = list(node.size = 8, label.size = 4))
```

```{r}
comm3_ega <- EGA(comm3_cor_matrix, n = nrow(comm3_symptom_data), plot.EGA = FALSE, model.args = list(lambda.min.ratio=0.1, gamma = 0))
```

```{r}
# Check variance of each column in cluster 4
colVars(comm4_symptom_data)
```

```{r}
# Remove nodes with no variance from comm4_symptom_data
reduced_comm4_symptom_data <- comm4_symptom_data[,colVars(comm4_symptom_data)>0]
```

```{r}
# Calculate the correlation matrix for cluster 4
# Assume that all variables are continuous and non-normal
comm4_cor_matrix <- cor_auto(reduced_comm4_symptom_data, detectOrdinal = FALSE, npn.SKEPTIC = TRUE, forcePD = TRUE)
```

```{r}
# Construct an EBIC-GLASSO regularized GGM using the EGA function from EGAnet
# EGA also identifies symptom clusters using the walktrap algorithm
comm4_ega <- EGA(comm4_cor_matrix, n = nrow(comm4_symptom_data), plot.EGA = FALSE)
# comm4_plot.ega <- plot(comm4_ega, plot.args = list(node.size = 8, label.size = 4))
```

### Run NCT between Clusters 1 and 2

```{r}
#Estimation function used for bootstrapping
#Calculates covariance matrix in same way as construct_network function

#Function with gamma=0.5
network_estimation_fun1 <- function(data) {
  cor_matrix <- cor_auto(data, detectOrdinal=FALSE, forcePD=TRUE, npn.SKEPTIC = TRUE)
  EBIC_matrix <- EBICglasso(cor_matrix, nrow(data), gamma=0.5)
  return(EBIC_matrix)
}

#Function with gamma=0
network_estimation_fun2 <- function(data) {
  cor_matrix <- cor_auto(data, detectOrdinal=FALSE, forcePD=TRUE, npn.SKEPTIC = TRUE)
  EBIC_matrix <- EBICglasso(cor_matrix, nrow(data), gamma=0)
  return(EBIC_matrix)
}
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
#Run NCT without correction for multiple comparisons (gamma=0.5)
if(!file.exists("data/comm1_comm2_NCTv1.RDS")){
  res <- NCT(comm1_symptom_data, comm2_symptom_data, it=2500, estimator = 'network_estimation_fun1', test.edges = TRUE, edges = 'all', p.adjust.methods = 'none', test.centrality = TRUE, centrality = c('closeness','betweenness','strength','expectedInfluence'), nodes = 'all')
  saveRDS(res, file.path("data/comm1_comm2_NCTv1.RDS"))
}
res1 <- readRDS(file.path("data/comm1_comm2_NCTv1.RDS"))
```

```{r, fig.width=2, fig.height=2}
plot(res1, what='network')
plot(res1, what='strength')
```

```{r}
edge_pvals_no_correction <- res1$einv.pvals
DT::datatable(edge_pvals_no_correction)
```

```{r}
centrality_pvals_no_correction <- res1$diffcen.pval
DT::datatable(centrality_pvals_no_correction)
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
#Run NCT without correction for multiple comparisons (gamma=0)
if(!file.exists("data/comm1_comm2_NCTv2.RDS")){
  res <- NCT(comm1_symptom_data, comm2_symptom_data, it=2500, estimator = 'network_estimation_fun2', test.edges = TRUE, edges = 'all', p.adjust.methods = 'none', test.centrality = TRUE, centrality = c('closeness','betweenness','strength','expectedInfluence'), nodes = 'all')
  saveRDS(res, file.path("data/comm1_comm2_NCTv2.RDS"))
}
res2 <- readRDS(file.path("data/comm1_comm2_NCTv2.RDS"))
```

```{r, fig.width=2, fig.height=2}
plot(res2, what='network')
plot(res2, what='strength')
```

```{r}
edge_pvals_no_correction <- res2$einv.pvals
DT::datatable(edge_pvals_no_correction)
```

```{r}
centrality_pvals_no_correction <- res2$diffcen.pval
DT::datatable(centrality_pvals_no_correction)
```

### Bootstrapping-based accuracy tests for Networks 1 and 2

```{r, results=FALSE, message=FALSE, warning=FALSE}
# Conduct non-parametric bootstrapping to analyze edge weight accuracy
if (!file.exists("data/comm1_nonparam_boot.RDS")){
  comm1_nonparam_boot <- bootnet(comm1_symptom_data, nBoots=2500, statistics=c('edge','strength','closeness','betweenness','bridgeStrength','bridgeCloseness','bridgeBetweenness'), fun='network_estimation_fun', communities=comm1_ega$wc)
  saveRDS(comm1_nonparam_boot, file=file.path("data/comm1_nonparam_boot.RDS"))
}
comm1_nonparam_boot <- readRDS(file.path("data/comm1_nonparam_boot.RDS"))
```

```{r, message=FALSE, warning=FALSE}
# Analyze edge weight accuracy
print(plot(comm1_nonparam_boot, labels = FALSE, order = "sample"))
comm1_summary_table <- summary(comm1_nonparam_boot, statistics = "edge")
DT::datatable(comm1_summary_table)
# Testing for significant differences in edge weights, without Bonferroni correction, for reasons details in Epskamp, Borsboom, & Fried 2017
plot(comm1_nonparam_boot, "edge", plot="difference", onlyNonZero=TRUE, order="sample", labels=FALSE)
```

```{r, message=FALSE, warning=FALSE, fig.width=1.8, fig.height=1.6}
p <- plot(comm1_nonparam_boot, labels = FALSE, order = "sample", sampleColor=red, bootColor=blue, meanColor=blue, meanlwd=0.4, bootAlpha=0.2, bootlwd=0.4, areaAlpha=0.5)
pp <- p + theme_minimal() + theme(legend.position = "top", axis.text.y = element_blank(), 
                                  legend.text = element_text(size=12),
                                  axis.text.x=element_text(size=12),
                                  strip.text=element_text(size=12), 
                                  panel.grid.major.y = element_blank(),
                                  panel.grid.minor.y = element_blank())
print(pp)
```

```{r}
comm1_summary_table['CIwidth'] <- comm1_summary_table['CIupper'] - comm1_summary_table['CIlower']
print(paste0('Median CI width for non-zero edges = ',median(comm1_summary_table[comm1_summary_table['sample']!=0,][['CIwidth']])))
print(paste0('Range of CI width for non-zero edges = ', min(comm1_summary_table[comm1_summary_table['sample']!=0,][['CIwidth']]), '-', max(comm1_summary_table[comm1_summary_table['sample']!=0,][['CIwidth']])))
```

```{r}
# Conduct casedrop bootstrapping
if (!file.exists("data/comm1_casedrop_boot.RDS")){
  comm1_casedrop_boot <- bootnet(comm1_symptom_data, nBoots=2500, type="case", statistics=c('edge','strength','closeness','betweenness','bridgeStrength','bridgeCloseness','bridgeBetweenness'), fun='network_estimation_fun', communities=comm1_ega$wc)
  saveRDS(comm1_casedrop_boot, file=file.path("data/comm1_casedrop_boot.RDS"))
}
comm1_casedrop_boot <- readRDS("data/comm1_casedrop_boot.RDS")
```

```{r}
# Plot casedrop bootstrapping results for edge weights
plot(comm1_casedrop_boot, statistics=c('edge'))
corStability(comm1_casedrop_boot)
```

```{r, fig.width=2.4, fig.height=1.6}
casedrop_boot_edge_plot <- plot(comm1_casedrop_boot, statistics=c('edge')) + theme_minimal() + xlab("% sampled cases") + ylab("correlation with original") + theme(axis.text.y =element_text(size=12),axis.text.x=element_text(size=12),axis.title =element_text(size=15), legend.text = element_text(size=15), legend.position = "top")
casedrop_boot_edge_plot
```

```{r}
# Plot casedrop bootstrapping results for centrality measures
plot(comm1_casedrop_boot, statistics=c('strength','closeness','betweenness'))
plot(comm1_casedrop_boot, statistics=c('bridgeStrength','bridgeCloseness','bridgeBetweenness'))
corStability(comm1_casedrop_boot)
```

```{r, fig.width=2.4, fig.height=1.6}
tolower_centrality_colors <- centrality_colors
names(tolower_centrality_colors) <- tolower(names(tolower_centrality_colors))

casedrop_boot_edge_plot <- plot(comm1_casedrop_boot, statistics=c('strength','closeness','betweenness')) + theme_minimal() + xlab("% sampled cases") + ylab("correlation with original") + theme(axis.text.y =element_text(size=12),axis.text.x=element_text(size=12),axis.title =element_text(size=15), legend.text = element_text(size=15), legend.position = "top") + scale_color_manual(values=tolower_centrality_colors, labels=names(centrality_colors)) + scale_fill_manual(values=tolower_centrality_colors, labels=names(centrality_colors)) + guides(fill=guide_legend(title=""), color=guide_legend(title=""))
casedrop_boot_edge_plot
```

```{r}
#Test for significant centrality differences without Bonferroni correction, for reasons details in Epskamp, Borsboom, & Fried 2017
print(plot(comm1_nonparam_boot, "strength"))
print(plot(comm1_nonparam_boot, "closeness"))
print(plot(comm1_nonparam_boot, "betweenness"))
```

```{r}
# Conduct node-drop bootstrapping
if(!file.exists("data/comm1_nodedrop_boot.RDS")){
  comm1_nodedrop_boot <- bootnet(comm1_symptom_data, nBoots=2500, type="node", statistics=c('edge','strength','closeness','betweenness'), fun='network_estimation_fun')
  saveRDS(comm1_nodedrop_boot, file=file.path("data/comm1_nodedrop_boot.RDS"))
}
comm1_nodedrop_boot <- readRDS("data/comm1_nodedrop_boot.RDS")
```

```{r}
plot(comm1_nodedrop_boot, statistics=c('edge'))
plot(comm1_nodedrop_boot, statistics=c('strength','closeness','betweenness'))
```

```{r}
plot(comm1_nodedrop_boot, statistics=c('strength'), perNode=TRUE)
plot(comm1_nodedrop_boot, statistics=c('closeness'), perNode=TRUE)
plot(comm1_nodedrop_boot, statistics=c('betweenness'), perNode=TRUE)
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
# Conduct non-parametric bootstrapping to analyze edge weight accuracy
if (!file.exists("data/comm2_nonparam_bootv2.RDS")){
  comm2_nonparam_boot <- bootnet(comm2_symptom_data, nBoots=2500, statistics=c('edge','strength','closeness','betweenness','bridgeStrength','bridgeCloseness','bridgeBetweenness'), fun='network_estimation_fun2', communities=comm2_ega$wc)
  saveRDS(comm2_nonparam_boot, file=file.path("data/comm2_nonparam_bootv2.RDS"))
}
comm2_nonparam_boot <- readRDS(file.path("data/comm2_nonparam_bootv2.RDS"))
```

```{r, message=FALSE, warning=FALSE}
# Analyze edge weight accuracy
print(plot(comm2_nonparam_boot, labels = FALSE, order = "sample"))
comm2_summary_table <- summary(comm2_nonparam_boot, statistics = "edge")
DT::datatable(comm2_summary_table)
# Testing for significant differences in edge weights, without Bonferroni correction, for reasons details in Epskamp, Borsboom, & Fried 2017
plot(comm2_nonparam_boot, "edge", plot="difference", onlyNonZero=TRUE, order="sample", labels=FALSE)
```

```{r, message=FALSE, warning=FALSE, fig.width=1.8, fig.height=1.6}
p <- plot(comm2_nonparam_boot, labels = FALSE, order = "sample", sampleColor=red, bootColor=blue, meanColor=blue, meanlwd=0.4, bootAlpha=0.2, bootlwd=0.4, areaAlpha=0.5)
pp <- p + theme_minimal() + theme(legend.position = "top", axis.text.y = element_blank(), 
                                  legend.text = element_text(size=12),
                                  axis.text.x=element_text(size=12),
                                  strip.text=element_text(size=12), 
                                  panel.grid.major.y = element_blank(),
                                  panel.grid.minor.y = element_blank())
print(pp)
```

```{r}
comm2_summary_table['CIwidth'] <- comm2_summary_table['CIupper'] - comm2_summary_table['CIlower']
print(paste0('Median CI width for non-zero edges = ',median(comm2_summary_table[comm2_summary_table['sample']!=0,][['CIwidth']])))
print(paste0('Range of CI width for non-zero edges = ', min(comm2_summary_table[comm2_summary_table['sample']!=0,][['CIwidth']]), '-', max(comm2_summary_table[comm2_summary_table['sample']!=0,][['CIwidth']])))
```

```{r}
# Conduct casedrop bootstrapping
if (!file.exists("data/comm2_casedrop_bootv2.RDS")){
  comm2_casedrop_boot <- bootnet(comm2_symptom_data, nBoots=2500, type="case", statistics=c('edge','strength','closeness','betweenness','bridgeStrength','bridgeCloseness','bridgeBetweenness'), fun='network_estimation_fun2', communities=comm2_ega$wc)
  saveRDS(comm2_casedrop_boot, file=file.path("data/comm2_casedrop_bootv2.RDS"))
}
comm2_casedrop_boot <- readRDS("data/comm2_casedrop_bootv2.RDS")
```

```{r}
# Plot casedrop bootstrapping results for edge weights
plot(comm2_casedrop_boot, statistics=c('edge'))
corStability(comm2_casedrop_boot)
```

```{r, fig.width=2.4, fig.height=1.6}
casedrop_boot_edge_plot <- plot(comm2_casedrop_boot, statistics=c('edge')) + theme_minimal() + xlab("% sampled cases") + ylab("correlation with original") + theme(axis.text.y =element_text(size=12),axis.text.x=element_text(size=12),axis.title =element_text(size=15), legend.text = element_text(size=15), legend.position = "top")
casedrop_boot_edge_plot
```

```{r}
# Plot casedrop bootstrapping results for centrality measures
plot(comm2_casedrop_boot, statistics=c('strength','closeness','betweenness'))
plot(comm2_casedrop_boot, statistics=c('bridgeStrength','bridgeCloseness','bridgeBetweenness'))
corStability(comm2_casedrop_boot)
```

```{r, fig.width=2.4, fig.height=1.6}
tolower_centrality_colors <- centrality_colors
names(tolower_centrality_colors) <- tolower(names(tolower_centrality_colors))

casedrop_boot_edge_plot <- plot(comm2_casedrop_boot, statistics=c('strength','closeness','betweenness')) + theme_minimal() + xlab("% sampled cases") + ylab("correlation with original") + theme(axis.text.y =element_text(size=12),axis.text.x=element_text(size=12),axis.title =element_text(size=15), legend.text = element_text(size=15), legend.position = "top") + scale_color_manual(values=tolower_centrality_colors, labels=names(centrality_colors)) + scale_fill_manual(values=tolower_centrality_colors, labels=names(centrality_colors)) + guides(fill=guide_legend(title=""), color=guide_legend(title=""))
casedrop_boot_edge_plot
```

```{r}
#Test for significant centrality differences without Bonferroni correction, for reasons details in Epskamp, Borsboom, & Fried 2017
print(plot(comm2_nonparam_boot, "strength"))
print(plot(comm2_nonparam_boot, "closeness"))
print(plot(comm2_nonparam_boot, "betweenness"))
```

```{r}
# Conduct node-drop bootstrapping
if (!file.exists("data/comm2_nodedrop_bootv2.RDS")){
  comm2_nodedrop_boot <- bootnet(comm2_symptom_data, nBoots=2500, type="node", statistics=c('edge','strength','closeness','betweenness'), fun='network_estimation_fun2')
  saveRDS(comm2_nodedrop_boot, file=file.path("data/comm2_nodedrop_bootv2.RDS"))
}
comm2_nodedrop_boot <- readRDS(file.path("data/comm2_nodedrop_bootv2.RDS"))
```

```{r}
plot(comm2_nodedrop_boot, statistics=c('edge'))
plot(comm2_nodedrop_boot, statistics=c('strength','closeness','betweenness'))
```

```{r}
plot(comm2_nodedrop_boot, statistics=c('strength'), perNode=TRUE)
plot(comm2_nodedrop_boot, statistics=c('closeness'), perNode=TRUE)
plot(comm2_nodedrop_boot, statistics=c('betweenness'), perNode=TRUE)
```

### Analyze demographics of each cluster

### Patients in cluster 2 tend to be older and have higher grade tumors than patients in cluster 1

### This matches the fact that network 2 is more driven by cognitive symptoms

```{r, results=FALSE, message=FALSE, warning=FALSE}
# Load clinical data
clinical_data <- read.csv('data/pioneer_mergedDataset_clinicalHarmonization.csv', stringsAsFactors = FALSE)
```

```{r}
# Format clinical data

# Change diagnosis variable to gbm vs non-gbm
clinical_data['orig_diagnosis'] <- clinical_data$diagnosis
clinical_data$diagnosis[(clinical_data$diagnosis != 'glioblastoma') & (!is.na(clinical_data$diagnosis))] <- 'non-gbm'

# Create one 'treatment status' variable that consolidates the information from the 'ontreat' and 'patgroup' variables
clinical_data['treatment_status'] <- NA
clinical_data$treatment_status[(clinical_data$ontreat == 'yes') | (clinical_data$patgroup == 'on treatment')] <- 'on'
clinical_data$treatment_status[(clinical_data$ontreat == 'no') | (clinical_data$patgroup == 'newly diagnosed') | (clinical_data$patgroup == 'surveillance')] <- 'off'

# Change ethnicity labels to acronyms
clinical_data$ethnicity[clinical_data$ethnicity == 'asian, asian or pacific islander'] = 'API'
clinical_data$ethnicity[clinical_data$ethnicity == 'black non-hispanic, black or african american'] = 'BAA'
clinical_data$ethnicity[clinical_data$ethnicity == 'hispanic, hispanic/latino'] = 'HL'
clinical_data$ethnicity[clinical_data$ethnicity == 'native american or alaskan native'] = 'NAAN'
clinical_data$ethnicity[clinical_data$ethnicity == 'white, white non-hispanic'] = 'WNH'

# Create new white_dichom variable
clinical_data['white_dichom'] <- 'no'
clinical_data$white_dichom[clinical_data$ethnicity == 'WNH'] <- 'yes'

# Create new hispanic_dichom variable
clinical_data['hispanic_dichom'] <- 'no'
clinical_data$hispanic_dichom[clinical_data$ethnicity == 'HL'] <- 'yes'

# Change 'employed' variable to yes/no
clinical_data$employed[clinical_data$employed=='employed full time'] = 'yes'
clinical_data$employed[clinical_data$employed=='not employed'] = 'no'

# Fill all gradedichom rows
clinical_data$gradedichom[clinical_data$grade==4 & !is.na(clinical_data$grade)] = 'high'
clinical_data$gradedichom[clinical_data$grade<4 & !is.na(clinical_data$grade)] = 'low'
clinical_data$gradedichom[is.na(clinical_data$grade)] = NA

# Fill all kpsdichom rows
clinical_data$kpsdichom[clinical_data$kps>=90 & !is.na(clinical_data$kps)] = 'high'
clinical_data$kpsdichom[clinical_data$kps<90 & !is.na(clinical_data$kps)] = 'low'
clinical_data$kpsdichom[is.na(clinical_data$kps)] = NA

# Change unknown vitalstatus variables to NA
clinical_data$vitalstatus[clinical_data$vitalstatus == 'unknown'] = NA

# clinical_data <- clinical_data %>% select(-c(`Study`, communityID))
clinical_data <- comm.assignment %>% left_join(clinical_data, by=c("sample"="ID"))
clinical_data <- clinical_data %>% mutate(age=ageSE) %>% select(-ageSE)
```

```{r}
table(clinical_data$community)
```

```{r}
colSums(!is.na(clinical_data))
```

```{r}
# Isolate clinical data for each cluster
comm1_clinical_data <- clinical_data[comms[[1]][[1]],]
comm2_clinical_data <- clinical_data[comms[[1]][[2]],]
comm3_clinical_data <- clinical_data[comms[[1]][[3]],]
comm4_clinical_data <- clinical_data[comms[[1]][[4]],]
```

```{r}
table(clinical_data$employed)/1128
sum(is.na(clinical_data$employed))/1128
```

```{r}
col <- 'employed'

t1 <- table(comm1_clinical_data[col])
print(t1)
print(t1/683)
sum(is.na(comm1_clinical_data[col]))
sum(is.na(comm1_clinical_data[col]))/683

t2 <- table(comm2_clinical_data[col])
print(t2)
print(t2/244)
sum(is.na(comm2_clinical_data[col]))
sum(is.na(comm2_clinical_data[col]))/244

t3 <- table(comm3_clinical_data[col])
print(t3)
print(t3/92)
sum(is.na(comm3_clinical_data[col]))
sum(is.na(comm3_clinical_data[col]))/92

t4 <- table(comm4_clinical_data[col])
print(t4)
print(t4/109)
sum(is.na(comm4_clinical_data[col]))
sum(is.na(comm4_clinical_data[col]))/109


```

```{r}
t <- table(comm4_clinical_data['setumorlobe'])
t[order(t)]
sum(is.na(comm4_clinical_data['setumorlobe']))
```

```{r}
col <- 'mood'

mean(unlist(comm1_clinical_data[col]), na.rm = TRUE)
sd(unlist(comm1_clinical_data[col]), na.rm = TRUE)
median(unlist(comm1_clinical_data[col]), na.rm = TRUE)
range(unlist(comm1_clinical_data[col]), na.rm = TRUE)
print('')

mean(unlist(comm2_clinical_data[col]), na.rm = TRUE)
sd(unlist(comm2_clinical_data[col]), na.rm = TRUE)
median(unlist(comm2_clinical_data[col]), na.rm = TRUE)
range(unlist(comm2_clinical_data[col]), na.rm = TRUE)
print('')

mean(unlist(comm3_clinical_data[col]), na.rm = TRUE)
sd(unlist(comm3_clinical_data[col]), na.rm = TRUE)
median(unlist(comm3_clinical_data[col]), na.rm = TRUE)
range(unlist(comm3_clinical_data[col]), na.rm = TRUE)
print('')

mean(unlist(comm4_clinical_data[col]), na.rm = TRUE)
sd(unlist(comm4_clinical_data[col]), na.rm = TRUE)
median(unlist(comm4_clinical_data[col]), na.rm = TRUE)
range(unlist(comm4_clinical_data[col]), na.rm = TRUE)
```

### Compare age of different clusters

```{r}
clinical_data %>% group_by(community) %>% summarize(mean_age=mean(age), sd_age=sd(age))
pairwise.t.test(clinical_data$age, clinical_data$community, p.adjust.method = 'bonferroni', pool.sd = TRUE)
pairwise.t.test(clinical_data$age, clinical_data$community, p.adjust.method = 'none', pool.sd = TRUE)
```

```{r, fig.width=2.5, fig.height=3.5}
cluster_comparisons <- list( c(1,2), c(2,4), c(3,4) )
p <- ggplot(clinical_data, aes(x=community,y=age,group=community, fill=community)) + 
  geom_boxplot() + theme_minimal() + 
  xlab("") +
  scale_fill_manual(values=community_colors) + 
  stat_compare_means(comparisons=cluster_comparisons, method="t.test", hide.ns = TRUE, label='p.signif', symnum.args = list(cutpoints=c(0,0.0000167,0.000167,0.00167,0.00833,1),symbols=c("****", "***", "**", "*", "ns"))) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position="none")
p
```

```{r, fig.width=3.5, fig.height=3.5}
p <- clinical_data %>% 
  ggplot(aes(x=age, group=community, color=community)) + 
  #geom_histogram() +
   geom_density(size=1) + theme_minimal() + 
   scale_color_manual(values=community_colors) + labs(color="Cluster") + xlab('age') + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_blank())
p
```

```{r}
# ggsave('poster_images/age_plot.png', plot = p, width = 8, height = 5)
#ggsave('images/age_plot.png', plot = p, width = 8, height = 5)
```

### Compare KPS of different clusters

```{r}
clinical_data %>% group_by(community) %>% summarize(mean_kps=mean(kps,na.rm=TRUE), sd_kps=sd(kps, na.rm=TRUE))
pairwise.t.test(clinical_data$kps, clinical_data$community, p.adjust.method = 'bonferroni', pool.sd = TRUE)
pairwise.t.test(clinical_data$kps, clinical_data$community, p.adjust.method = 'none', pool.sd = TRUE)
```

```{r, fig.width=2.5, fig.height=3.5}
cluster_comparisons <- list( c(1,2), c(2,4), c(3,4) )
p <- ggplot(clinical_data %>% mutate(KPS=kps), aes(x=community,y=KPS,group=community, fill=community)) + 
  geom_boxplot() + theme_minimal() + 
  xlab("") +
  scale_fill_manual(values=community_colors) + 
  stat_compare_means(comparisons=cluster_comparisons, method="t.test", hide.ns = TRUE, label='p.signif', symnum.args = list(cutpoints=c(0,0.0000167,0.000167,0.00167,0.00833,1),symbols=c("****", "***", "**", "*", "ns"))) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position="none")
p
```

```{r}
table(clinical_data$community, clinical_data$kpsdichom, useNA = "ifany")

pairwise.fisher.test(clinical_data$kpsdichom, clinical_data$cluster, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$kpsdichom, clinical_data$cluster, p.adjust.method = 'none')
```

```{r, fig.width=6, fig.height=3.5}
p <- ggplot(data = clinical_data %>% filter(!is.na(kpsdichom))) + geom_mosaic(aes(x=product(kpsdichom,community),fill=kpsdichom)) +theme_minimal() +
  xlab("") + scale_fill_manual(values = c("#e4211c", "#387db8", "#4caf4a", "#ff7f00")) + ylab('KPS') + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_blank())
p
#ggsave('images/kps_plot.png', plot = kps_plot, width = 8, height = 5)
```

### Compare categorical demographic characterstics

```{r}
table(clinical_data$community, clinical_data$sex, useNA = "ifany")
pairwise.fisher.test(clinical_data$sex, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$sex, clinical_data$community, p.adjust.method = 'none')
```

```{r}
table(clinical_data$community, clinical_data$ethnicity, useNA = "ifany")

pairwise.fisher.test(clinical_data$ethnicity, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$ethnicity, clinical_data$community, p.adjust.method = 'none')
```

```{r, fig.width=6, fig.height=3.5}
clinical_data$ethnicity <- as.character(clinical_data$ethnicity)
p <- ggplot(data = clinical_data) + geom_mosaic(aes(x=product(ethnicity,community),fill=ethnicity)) + theme_minimal() +
  xlab("") + scale_fill_manual(values = c("#e4211c", "#387db8", "#4caf4a","#4B0082", "#ff7f00")) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_blank())

p
```

```{r}
table(clinical_data$community, clinical_data$white_dichom, useNA = "ifany")

pairwise.fisher.test(clinical_data$white_dichom, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$white_dichom, clinical_data$community, p.adjust.method = 'none')
```

```{r}
table(clinical_data$community, clinical_data$hispanic_dichom, useNA = "ifany")

pairwise.fisher.test(clinical_data$hispanic_dichom, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$hispanic_dichom, clinical_data$community, p.adjust.method = 'none')
```

```{r}
table(clinical_data$community, clinical_data$education, useNA = "ifany")

pairwise.fisher.test(clinical_data$education, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$education, clinical_data$community, p.adjust.method = 'none')
```

```{r, r, fig.width=8, fig.height=3.5}
clinical_data$education <- as.character(clinical_data$education)
p <- ggplot(clinical_data %>% filter(!is.na(education))) + geom_mosaic(aes(x=product(education,community),fill=education)) + theme_minimal() + 
  xlab("") + scale_fill_manual(values = c("#e4211c", "#387db8", "#4caf4a", "#ff7f00")) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_blank())

p
```

```{r}
table(clinical_data$community, clinical_data$employed, useNA = "ifany")

pairwise.fisher.test(clinical_data$employed, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$employed, clinical_data$community, p.adjust.method = 'none')
```

```{r}
table(clinical_data$community, clinical_data$income, useNA = "ifany")

pairwise.fisher.test(clinical_data$income, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$income, clinical_data$community, p.adjust.method = 'none')
```

```{r, fig.width=8, fig.height=3.5}
clinical_data$income <- as.character(clinical_data$income)
p <- ggplot(data = clinical_data) + geom_mosaic(aes(x=product(income,community),fill=income)) + theme_minimal() + 
  xlab("") + scale_fill_manual(values = c("#e4211c", "#387db8", "#4caf4a","#4B0082")) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_blank())
p
```

```{r}
table(clinical_data$community, clinical_data$diagnosis, useNA = "ifany")

pairwise.fisher.test(clinical_data$diagnosis, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$diagnosis, clinical_data$community, p.adjust.method = 'none')
```

```{r}
table(clinical_data$community, clinical_data$grade, useNA = "ifany")
pairwise.fisher.test(clinical_data$grade, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$grade, clinical_data$community, p.adjust.method = 'none')
```

```{r}
clinical_data$grade <- as.character(clinical_data$grade)
p <- ggplot(data = clinical_data) + geom_mosaic(aes(x=product(grade,community),fill=grade)) + theme_minimal() + 
  xlab("")+ scale_fill_manual(values = c("#e4211c", "#387db8", "#4caf4a", "#ff7f00")) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_blank())

p
#ggsave('images/grade_plot.png', plot = grade_plot, width = 8, height = 5)
```

```{r}
table(clinical_data$community, clinical_data$gradedichom, useNA = "ifany")

pairwise.fisher.test(clinical_data$gradedichom, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$gradedichom, clinical_data$community, p.adjust.method = 'none')
```

```{r}
table(clinical_data$community, clinical_data$treatment_status, useNA = "ifany")
pairwise.fisher.test(clinical_data$treatment_status, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$treatment_status, clinical_data$community, p.adjust.method = 'none')
```

```{r}
table(clinical_data$community, clinical_data$vitalstatus, useNA = "ifany")
pairwise.fisher.test(clinical_data$vitalstatus, clinical_data$community, p.adjust.method = 'bonferroni')
pairwise.fisher.test(clinical_data$vitalstatus, clinical_data$community, p.adjust.method = 'none')
```

```{r}
clinical_data$vitalstatus <- as.character(clinical_data$vitalstatus)
p <- ggplot(data = clinical_data) + geom_mosaic(aes(x=product(vitalstatus,community),fill=vitalstatus)) + theme_minimal() + 
  xlab("") + scale_fill_manual(values = c("#e4211c", "#387db8", "#4caf4a","#4B0082")) + theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_blank())

p
```

```{r}
table(clinical_data$community, clinical_data$setumorlobe, useNA = "ifany")
```

### Interference Items

```{r, results=FALSE, message=FALSE, warning=FALSE}
interference_items <- read.csv('data/merged_pioneer_symptoms_interference.csv', stringsAsFactors = FALSE) 

interference_items <- interference_items %>% select(ID, activity, mood, work, relations, walking,enjoyment)
# Average all interference items
interference_items$overall<- rowMeans(interference_items[2:7])
interference_items$activity <- rowMeans(interference_items[,c('activity','work','walking')])
interference_items$mood <- rowMeans(interference_items[,c('mood','relations','enjoyment')])

clinical_data <- clinical_data %>% left_join(interference_items%>% select(ID, overall, activity, mood), by=c("sample"="ID"))
```

```{r}
clinical_data_long <- clinical_data %>% transmute(sample, community, age, KPS=kps, overall, activity, mood) %>% pivot_longer(-c(community, sample), names_to = "demographic", values_to ="measure")
```

```{r, fig.height=1.6, fig.width=3}
cluster_comparisons <- list( c(1,2), c(1,3), c(1,4), c(2,4), c(3,4) )
sig_levels = c(0,0.00000111,0.0000111,0.000111,0.000556,1)
p <- ggplot(clinical_data_long %>% filter(demographic%in%c("overall", "activity", "mood")) %>% mutate(demographic=factor(demographic, levels=c("overall", "activity", "mood"))), aes(x=community,y=measure,group=community, fill=community)) + 
  geom_boxplot() + theme_minimal() + 
  facet_wrap(~demographic) +
  xlab("") +
  ylab("interference") +
  scale_fill_manual(values=community_colors) + 
  stat_compare_means(comparisons=cluster_comparisons, method="t.test", hide.ns = FALSE, label='p.signif', symnum.args = list(cutpoints=sig_levels,symbols=c("****", "***", "**", "*", "ns")), size=3) + theme(axis.text = element_text(size = 9), axis.title = element_text(size = 10), legend.text = element_text(size = 9), legend.position="none", strip.text=element_text(size=10))
p
```

```{r, fig.height=1.6, fig.width=2}
cluster_comparisons <- list( c(1,2),c(1,4), c(2,4), c(3,4) )
p <- ggplot(clinical_data_long %>% filter(demographic%in%c("age", "KPS")), aes(x=community,y=measure,group=community, fill=community)) + 
  geom_boxplot() + theme_minimal() + 
  facet_wrap(~demographic) +
  xlab("") +
  ylab("") +
  scale_fill_manual(values=community_colors) + 
  stat_compare_means(comparisons=cluster_comparisons, method="t.test", hide.ns = FALSE, label='p.signif', symnum.args = list(cutpoints=sig_levels,symbols=c("****", "***", "**", "*", "ns")), size=3) + theme(axis.text = element_text(size = 9), axis.title = element_text(size = 10), legend.text = element_text(size = 9), legend.position="none", strip.text=element_text(size=10))
p
```

```{r}
mean(clinical_data$mood, na.rm=TRUE)
sd(clinical_data$mood, na.rm=TRUE)
median(clinical_data$mood, na.rm=TRUE)
range(clinical_data$mood, na.rm=TRUE)
```

```{r}
### Get number of patients that experience at least one interference
tmp <- clinical_data[c('mood')]
tmp <- na.omit(tmp)
sum(rowSums(tmp)!=0)
```
